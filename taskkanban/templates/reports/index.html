{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "报表仪表板" %}{% endblock %}

{% block extra_css %}
<style>
.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    border-left: 4px solid;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.stat-card.primary { border-left-color: #007bff; }
.stat-card.success { border-left-color: #28a745; }
.stat-card.warning { border-left-color: #ffc107; }
.stat-card.danger { border-left-color: #dc3545; }
.stat-card.info { border-left-color: #17a2b8; }

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    line-height: 1;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9rem;
    margin-top: 0.5rem;
}

.chart-container {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
}

.chart-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: #495057;
}

.filter-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.recent-reports {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.report-item {
    padding: 0.8rem;
    border-left: 3px solid #007bff;
    background: #f8f9fa;
    margin-bottom: 0.8rem;
    border-radius: 0 5px 5px 0;
    transition: background-color 0.2s;
}

.report-item:hover {
    background: #e9ecef;
}

.report-name {
    font-weight: 600;
    color: #495057;
}

.report-date {
    font-size: 0.8rem;
    color: #6c757d;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header text-center">
    <h1><i class="fas fa-chart-bar me-2"></i>{% trans "报表仪表板" %}</h1>
    <p class="mb-0">{% trans "实时监控项目进度和团队绩效" %}</p>
</div>

<!-- 筛选器 -->
<div class="filter-section">
    <form method="get" class="row align-items-end">
        <div class="col-md-3">
            {{ filter_form.start_date.label_tag }}
            {{ filter_form.start_date }}
        </div>
        <div class="col-md-3">
            {{ filter_form.end_date.label_tag }}
            {{ filter_form.end_date }}
        </div>
        <div class="col-md-2">
            {{ filter_form.team.label_tag }}
            {{ filter_form.team }}
        </div>
        <div class="col-md-2">
            {{ filter_form.board.label_tag }}
            {{ filter_form.board }}
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-filter me-1"></i>{% trans "筛选" %}
            </button>
        </div>
    </form>
</div>

<!-- 统计卡片 -->
<div class="row mb-4">
    <div class="col-md-2 col-sm-6 mb-3">
        <div class="stat-card primary">
            <div class="stat-number">{{ task_stats.total_tasks|default:0 }}</div>
            <div class="stat-label">{% trans "总任务数" %}</div>
        </div>
    </div>
    <div class="col-md-2 col-sm-6 mb-3">
        <div class="stat-card success">
            <div class="stat-number">{{ task_stats.completed_tasks|default:0 }}</div>
            <div class="stat-label">{% trans "已完成" %}</div>
        </div>
    </div>
    <div class="col-md-2 col-sm-6 mb-3">
        <div class="stat-card warning">
            <div class="stat-number">{{ task_stats.in_progress_tasks|default:0 }}</div>
            <div class="stat-label">{% trans "进行中" %}</div>
        </div>
    </div>
    <div class="col-md-2 col-sm-6 mb-3">
        <div class="stat-card info">
            <div class="stat-number">{{ task_stats.todo_tasks|default:0 }}</div>
            <div class="stat-label">{% trans "待办" %}</div>
        </div>
    </div>
    <div class="col-md-2 col-sm-6 mb-3">
        <div class="stat-card danger">
            <div class="stat-number">{{ task_stats.overdue_tasks|default:0 }}</div>
            <div class="stat-label">{% trans "逾期" %}</div>
        </div>
    </div>
    <div class="col-md-2 col-sm-6 mb-3">
        <div class="stat-card primary">
            <div class="stat-number">{{ task_stats.completion_rate|floatformat:1|default:0 }}%</div>
            <div class="stat-label">{% trans "完成率" %}</div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row">
    <!-- 任务完成趋势 -->
    <div class="col-lg-8 mb-4">
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-line-chart me-2"></i>{% trans "任务完成趋势" %}
            </div>
            <canvas id="completionTrendChart" height="80"></canvas>
        </div>
    </div>
    
    <!-- 任务状态分布 -->
    <div class="col-lg-4 mb-4">
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-pie-chart me-2"></i>{% trans "任务状态分布" %}
            </div>
            <canvas id="statusDistributionChart"></canvas>
        </div>
    </div>
</div>

<div class="row">
    <!-- 用户工作量 -->
    <div class="col-lg-8 mb-4">
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-bar-chart me-2"></i>{% trans "用户工作量分布" %}
            </div>
            <canvas id="userWorkloadChart" height="80"></canvas>
        </div>
    </div>
    
    <!-- 最近的报表 -->
    <div class="col-lg-4 mb-4">
        <div class="recent-reports">
            <div class="chart-title">
                <i class="fas fa-history me-2"></i>{% trans "最近的报表" %}
            </div>
            {% if user_reports %}
                {% for report in user_reports %}
                <div class="report-item">
                    <div class="report-name">{{ report.name }}</div>
                    <div class="report-date">{{ report.created_at|date:"Y-m-d H:i" }}</div>
                </div>
                {% endfor %}
                <div class="text-center mt-3">
                    <a href="{% url 'reports:list' %}" class="btn btn-outline-primary btn-sm">
                        {% trans "查看全部" %}
                    </a>
                </div>
            {% else %}
                <p class="text-muted text-center py-3">{% trans "暂无报表" %}</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- 快速导航 -->
<div class="row">
    <div class="col-12">
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-rocket me-2"></i>{% trans "快速导航" %}
            </div>
            <div class="row">
                <div class="col-md-3 mb-2">
                    <a href="{% url 'reports:tasks' %}" class="btn btn-outline-primary w-100">
                        <i class="fas fa-tasks me-2"></i>{% trans "任务报表" %}
                    </a>
                </div>
                <div class="col-md-3 mb-2">
                    <a href="{% url 'reports:team_performance' %}" class="btn btn-outline-success w-100">
                        <i class="fas fa-users me-2"></i>{% trans "团队绩效" %}
                    </a>
                </div>
                <div class="col-md-3 mb-2">
                    <a href="{% url 'reports:project_progress' %}" class="btn btn-outline-info w-100">
                        <i class="fas fa-project-diagram me-2"></i>{% trans "项目进度" %}
                    </a>
                </div>
                <div class="col-md-3 mb-2">
                    <a href="{% url 'reports:custom' %}" class="btn btn-outline-warning w-100">
                        <i class="fas fa-cogs me-2"></i>{% trans "自定义报表" %}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 任务完成趋势图
    const completionTrendData = {{ chart_data.task_completion_trend|safe }};
    if (completionTrendData) {
        const ctx1 = document.getElementById('completionTrendChart').getContext('2d');
        new Chart(ctx1, {
            type: 'line',
            data: completionTrendData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // 任务状态分布图
    const statusDistributionData = {{ chart_data.status_distribution|safe }};
    if (statusDistributionData) {
        const ctx2 = document.getElementById('statusDistributionChart').getContext('2d');
        new Chart(ctx2, {
            type: 'doughnut',
            data: statusDistributionData,
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // 用户工作量图
    const userWorkloadData = {{ chart_data.user_workload|safe }};
    if (userWorkloadData) {
        const ctx3 = document.getElementById('userWorkloadChart').getContext('2d');
        new Chart(ctx3, {
            type: 'bar',
            data: userWorkloadData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
